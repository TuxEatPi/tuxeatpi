general:
  branches:
    ignore:
      - gh-pages

machine:
  pre:
    - wget https://s3.amazonaws.com/circle-downloads/circle-pyenv-python-3.5.1_1.0_amd64.deb
    - sudo dpkg -i circle-pyenv-python-3.5.1_1.0_amd64.deb

  python:
    version: 3.5.1

dependencies:
  pre:
    - sudo apt-get install libsamplerate0-dev portaudio19-dev libspeexdsp-dev
    - pip install -r requirements-dev.txt --upgrade
    - pip install -r requirements.txt --upgrade
    - pip install codeclimate-test-reporter
    - python setup.py install

test:
  override:
    - make lang-gen
    - pep8 --max-line-length=100 --exclude='*.pyc' --exclude=tuxeatpi/experimental tuxeatpi
    - pylint --rcfile=.pylintrc -r no tuxeatpi
    - coverage run --include='*/tuxeatpi/*' --omit='*/tuxeatpi/tests/*' `which nosetests` --with-html --with-xunit tuxeatpi tests 
    - coverage combine
    - coverage report
    - coverage html --include='*/tuxeatpi/*' --omit='*/tuxeatpi/tests/*'
    - CODECLIMATE_REPO_TOKEN=${CODECLIMATE_REPO_TOKEN} codeclimate-test-reporter
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/xunit/
    - cp nosetests.xml $CIRCLE_TEST_REPORTS/xunit/
    - mkdir -p $CIRCLE_TEST_REPORTS/html/
    - cp nosetests.html $CIRCLE_TEST_REPORTS/html/
    - cp -r htmlcov $CIRCLE_TEST_REPORTS/coverage

deployment:
  gh_pages:
    branch: master
    commands:
      - python setup.py develop
      - python -c "import tuxeatpi"
      - make doc-generate
      - rm -rf ../documentation
      - mkdir ../documentation
      - cd ../documentation && git init
      - cd ../documentation && git remote add origin https://${GH_TOKEN}:x-oauth-basic@github.com/TuxEatPi/tuxeatpi.git
      - cd ../documentation && git pull origin gh-pages
      - cd ../documentation && git checkout gh-pages
      - cd ../documentation && git clean -fxd
      - cd ../documentation && git config user.name 'Tuxeatpi Team'
      - cd ../documentation && git config user.email 'tuxeatpi@tuxeatpi.org'
      - cd ../documentation && rm -rf *
      - cp -r doc/build/html/* ../documentation/
      - cp doc/build/html/.nojekyll ../documentation/
      - cd ../documentation && git add .
      - cd ../documentation && git commit -m "Update documentation on $(date '+%Y/%m/%d%H:%M:%S')"
      - cd ../documentation && git push origin gh-pages --force
